(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{1084:function(a,s,t){"use strict";t.r(s);var n=t(28),e=Object(n.a)({},(function(){var a=this,s=a.$createElement,n=a._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[n("h1",{attrs:{id:"_06-dubbo-负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_06-dubbo-负载均衡"}},[a._v("#")]),a._v(" 06-Dubbo 负载均衡")]),a._v(" "),n("h2",{attrs:{id:"概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[a._v("#")]),a._v(" 概述")]),a._v(" "),n("p",[a._v("在集群负载均衡时，Dubbo 提供了多种均衡策略，缺省为 "),n("code",[a._v("random")]),a._v(" 随机调用。")]),a._v(" "),n("h2",{attrs:{id:"负载均衡策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡策略"}},[a._v("#")]),a._v(" 负载均衡策略")]),a._v(" "),n("h3",{attrs:{id:"随机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#随机"}},[a._v("#")]),a._v(" 随机")]),a._v(" "),n("p",[n("strong",[a._v("Random LoadBalance：")]),a._v(" 按权重设置随机概率，在一个截面上碰撞的概率高，但调用量越大分布越均匀，而且按概率使用权重后也比较均匀，有利于动态调整提供者权重。")]),a._v(" "),n("h3",{attrs:{id:"轮循"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#轮循"}},[a._v("#")]),a._v(" 轮循")]),a._v(" "),n("p",[n("strong",[a._v("RoundRobin LoadBalance：")]),a._v(" 按公约后的权重设置轮询比率，存在慢的提供者累积请求的问题，比如：第二台机器很慢，但没挂，当请求调到第二台时就卡在那，久而久之，所有请求都卡在调到第二台上。")]),a._v(" "),n("h3",{attrs:{id:"最少活跃调用数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最少活跃调用数"}},[a._v("#")]),a._v(" 最少活跃调用数")]),a._v(" "),n("p",[n("strong",[a._v("LeastActive LoadBalance：")]),a._v(" 相同活跃数的随机，活跃数指调用前后计数差，使慢的提供者收到更少请求，因为越慢的提供者的调用前后计数差会越大。")]),a._v(" "),n("h3",{attrs:{id:"一致性-hash"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一致性-hash"}},[a._v("#")]),a._v(" 一致性 Hash")]),a._v(" "),n("p",[n("strong",[a._v("ConsistentHash LoadBalance：")]),a._v(" 相同参数的请求总是发到同一提供者。当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。")]),a._v(" "),n("p",[a._v("算法参见："),n("a",{attrs:{href:"http://www.qfdmy.com/wp-content/themes/quanbaike/go.php?url=aHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db25zaXN0ZW50X2hhc2hpbmc=",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://en.wikipedia.org/wiki/Consistent_hashing"),n("OutboundLink")],1),a._v(" ，缺省只对第一个参数 Hash，如果要修改，请配置 "),n("code",[a._v("，缺省用 160 份虚拟节点，如果要修改，请配置")])]),a._v(" "),n("h2",{attrs:{id:"配置负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置负载均衡"}},[a._v("#")]),a._v(" 配置负载均衡")]),a._v(" "),n("ul",[n("li",[a._v("修改 "),n("code",[a._v("dubbo-provider")]),a._v(" 项目的负载均衡策略，默认的负载均衡策略是 "),n("strong",[a._v("随机")]),a._v("，我们修改为 "),n("strong",[a._v("轮循")]),a._v("，可配置的值分别是："),n("code",[a._v("random")]),a._v("，"),n("code",[a._v("roundrobin")]),a._v("，"),n("code",[a._v("leastactive")]),a._v("，"),n("code",[a._v("consistenthash")])])]),a._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("dubbo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("provider")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("loadbalance")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" roundrobin\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br")])]),n("ul",[n("li",[a._v("修改 "),n("code",[a._v("dubbo-provider")]),a._v(" 的协议端口为 20880 和 20881，并启动多个实例，IDEA 中依次点击 "),n("strong",[a._v("Run")]),a._v(" -> "),n("strong",[a._v("Edit Configurations")]),a._v(" 并勾选 "),n("strong",[a._v("Allow parallel run")]),a._v(" 以允许 IDEA 多实例运行项目")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(588),alt:"img"}})]),a._v(" "),n("ul",[n("li",[a._v("Nacos Server 控制台可以看到 "),n("code",[a._v("dubbo-provider")]),a._v(" 有 2 个实例")])]),a._v(" "),n("p",[n("img",{attrs:{src:t(589),alt:"img"}})]),a._v(" "),n("ul",[n("li",[a._v("修改 "),n("code",[a._v("dubbo-provider")]),a._v(" 项目的 "),n("code",[a._v("EchoServiceImpl")]),a._v(" 中的测试方法")])]),a._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("package")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("funtl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("apache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("dubbo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("provider"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("import")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("funtl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("apache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("dubbo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("provider"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("api")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("EchoService")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("import")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("apache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("dubbo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("config"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("annotation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("import")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("org"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("springframework"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("beans"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("factory"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("annotation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Value")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Service")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("version "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[a._v('"1.0.0"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("EchoServiceImpl")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("implements")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("EchoService")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Value")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[a._v('"${dubbo.protocol.port}"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("private")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[a._v("@Override")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[a._v("echo")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),a._v(" string"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Echo Hello Dubbo "')]),a._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" string "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[a._v('" i am from port: "')]),a._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br"),n("span",{staticClass:"line-number"},[a._v("3")]),n("br"),n("span",{staticClass:"line-number"},[a._v("4")]),n("br"),n("span",{staticClass:"line-number"},[a._v("5")]),n("br"),n("span",{staticClass:"line-number"},[a._v("6")]),n("br"),n("span",{staticClass:"line-number"},[a._v("7")]),n("br"),n("span",{staticClass:"line-number"},[a._v("8")]),n("br"),n("span",{staticClass:"line-number"},[a._v("9")]),n("br"),n("span",{staticClass:"line-number"},[a._v("10")]),n("br"),n("span",{staticClass:"line-number"},[a._v("11")]),n("br"),n("span",{staticClass:"line-number"},[a._v("12")]),n("br"),n("span",{staticClass:"line-number"},[a._v("13")]),n("br"),n("span",{staticClass:"line-number"},[a._v("14")]),n("br"),n("span",{staticClass:"line-number"},[a._v("15")]),n("br"),n("span",{staticClass:"line-number"},[a._v("16")]),n("br"),n("span",{staticClass:"line-number"},[a._v("17")]),n("br"),n("span",{staticClass:"line-number"},[a._v("18")]),n("br")])]),n("ul",[n("li",[a._v("重启服务，通过浏览器访问 "),n("a",{attrs:{href:"http://www.qfdmy.com/wp-content/themes/quanbaike/go.php?url=aHR0cDovL2xvY2FsaG9zdDo4MDgwL2VjaG8vaGk=",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://localhost:8080/echo/hi"),n("OutboundLink")],1),a._v(" ，反复刷新浏览器，浏览器交替显示")])]),a._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[a._v("Echo Hello Dubbo hi i am from port: 20880\nEcho Hello Dubbo hi i am from port: 20881\n")])]),a._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[a._v("1")]),n("br"),n("span",{staticClass:"line-number"},[a._v("2")]),n("br")])])])}),[],!1,null,null,null);s.default=e.exports},588:function(a,s,t){a.exports=t.p+"assets/img/9b0a0ba30182ae3.f89177f4.png"},589:function(a,s,t){a.exports=t.p+"assets/img/6b78be78da8dc0a.337d82b1.png"}}]);