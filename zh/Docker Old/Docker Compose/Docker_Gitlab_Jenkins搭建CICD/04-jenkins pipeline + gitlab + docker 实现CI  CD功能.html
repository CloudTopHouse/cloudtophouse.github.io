<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jenkins pipeline + gitlab + docker 实现 CI / CD 功能 | 山河社稷图</title>
    <meta name="description" content="学习笔记">
    <link rel="icon" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
    
    <link rel="preload" href="/assets/css/0.styles.bf9a1d7a.css" as="style"><link rel="preload" href="/assets/js/app.ace6c021.js" as="script"><link rel="preload" href="/assets/js/3.c5eec2af.js" as="script"><link rel="preload" href="/assets/js/100.5622807f.js" as="script"><link rel="prefetch" href="/assets/js/10.940c777e.js"><link rel="prefetch" href="/assets/js/101.988e1b60.js"><link rel="prefetch" href="/assets/js/102.9f15a644.js"><link rel="prefetch" href="/assets/js/103.19a90c71.js"><link rel="prefetch" href="/assets/js/104.80314083.js"><link rel="prefetch" href="/assets/js/105.4d78f602.js"><link rel="prefetch" href="/assets/js/106.620f9fea.js"><link rel="prefetch" href="/assets/js/107.77095272.js"><link rel="prefetch" href="/assets/js/108.199c4b01.js"><link rel="prefetch" href="/assets/js/109.dd98790d.js"><link rel="prefetch" href="/assets/js/11.d8b92bf2.js"><link rel="prefetch" href="/assets/js/110.62810427.js"><link rel="prefetch" href="/assets/js/111.03c6b170.js"><link rel="prefetch" href="/assets/js/112.dbbd9ae0.js"><link rel="prefetch" href="/assets/js/113.0107fe5d.js"><link rel="prefetch" href="/assets/js/114.0632b1c5.js"><link rel="prefetch" href="/assets/js/115.b69b4641.js"><link rel="prefetch" href="/assets/js/116.fda844f7.js"><link rel="prefetch" href="/assets/js/117.44a0d661.js"><link rel="prefetch" href="/assets/js/118.c03574d4.js"><link rel="prefetch" href="/assets/js/119.265c0a0a.js"><link rel="prefetch" href="/assets/js/12.dbb47cb6.js"><link rel="prefetch" href="/assets/js/120.32618c36.js"><link rel="prefetch" href="/assets/js/121.210d70da.js"><link rel="prefetch" href="/assets/js/122.b6a650ea.js"><link rel="prefetch" href="/assets/js/123.d01f77ce.js"><link rel="prefetch" href="/assets/js/124.f47cb1ba.js"><link rel="prefetch" href="/assets/js/125.c221c6f8.js"><link rel="prefetch" href="/assets/js/126.98e71089.js"><link rel="prefetch" href="/assets/js/127.2a38377a.js"><link rel="prefetch" href="/assets/js/128.1c299d80.js"><link rel="prefetch" href="/assets/js/129.d44adc3a.js"><link rel="prefetch" href="/assets/js/13.e24d5ecb.js"><link rel="prefetch" href="/assets/js/130.82abaf80.js"><link rel="prefetch" href="/assets/js/131.65b2d510.js"><link rel="prefetch" href="/assets/js/132.34b92a02.js"><link rel="prefetch" href="/assets/js/133.9260383e.js"><link rel="prefetch" href="/assets/js/134.db23db1f.js"><link rel="prefetch" href="/assets/js/135.fdc0e1bc.js"><link rel="prefetch" href="/assets/js/136.f0858414.js"><link rel="prefetch" href="/assets/js/137.db9c8ac4.js"><link rel="prefetch" href="/assets/js/138.9a10712c.js"><link rel="prefetch" href="/assets/js/139.da113638.js"><link rel="prefetch" href="/assets/js/14.ed205d8b.js"><link rel="prefetch" href="/assets/js/140.e5830eb6.js"><link rel="prefetch" href="/assets/js/141.851e562a.js"><link rel="prefetch" href="/assets/js/142.4192eee6.js"><link rel="prefetch" href="/assets/js/143.ac34ce39.js"><link rel="prefetch" href="/assets/js/144.147b5396.js"><link rel="prefetch" href="/assets/js/145.f6a6d4e3.js"><link rel="prefetch" href="/assets/js/146.87f8b051.js"><link rel="prefetch" href="/assets/js/147.f8eaa5f1.js"><link rel="prefetch" href="/assets/js/148.f4013076.js"><link rel="prefetch" href="/assets/js/149.5d124d8d.js"><link rel="prefetch" href="/assets/js/15.45d51131.js"><link rel="prefetch" href="/assets/js/150.17957dc8.js"><link rel="prefetch" href="/assets/js/151.4d492527.js"><link rel="prefetch" href="/assets/js/152.2619297f.js"><link rel="prefetch" href="/assets/js/153.e01fe128.js"><link rel="prefetch" href="/assets/js/154.334b5a60.js"><link rel="prefetch" href="/assets/js/155.5d624fa2.js"><link rel="prefetch" href="/assets/js/156.e7297ed7.js"><link rel="prefetch" href="/assets/js/157.5c76e4f9.js"><link rel="prefetch" href="/assets/js/158.51b94166.js"><link rel="prefetch" href="/assets/js/159.14b5edae.js"><link rel="prefetch" href="/assets/js/16.e01c790b.js"><link rel="prefetch" href="/assets/js/160.c64ea0e2.js"><link rel="prefetch" href="/assets/js/161.0ceadd71.js"><link rel="prefetch" href="/assets/js/162.e54a0eac.js"><link rel="prefetch" href="/assets/js/163.f92537d9.js"><link rel="prefetch" href="/assets/js/164.0aa8adb8.js"><link rel="prefetch" href="/assets/js/165.53fe35e1.js"><link rel="prefetch" href="/assets/js/166.a9812cfa.js"><link rel="prefetch" href="/assets/js/167.af27ebe9.js"><link rel="prefetch" href="/assets/js/168.feca41e7.js"><link rel="prefetch" href="/assets/js/169.a320dab5.js"><link rel="prefetch" href="/assets/js/17.fb8e84d9.js"><link rel="prefetch" href="/assets/js/170.de76b281.js"><link rel="prefetch" href="/assets/js/171.6e412286.js"><link rel="prefetch" href="/assets/js/172.7c64fbbe.js"><link rel="prefetch" href="/assets/js/173.169e0fa2.js"><link rel="prefetch" href="/assets/js/174.805706ce.js"><link rel="prefetch" href="/assets/js/175.1b86965f.js"><link rel="prefetch" href="/assets/js/176.7c68461e.js"><link rel="prefetch" href="/assets/js/177.a88e24a9.js"><link rel="prefetch" href="/assets/js/178.649f7641.js"><link rel="prefetch" href="/assets/js/179.224575da.js"><link rel="prefetch" href="/assets/js/18.350b6168.js"><link rel="prefetch" href="/assets/js/180.0aaa3b3a.js"><link rel="prefetch" href="/assets/js/181.70ddcb0d.js"><link rel="prefetch" href="/assets/js/182.81bab1f9.js"><link rel="prefetch" href="/assets/js/183.1b64d593.js"><link rel="prefetch" href="/assets/js/184.a2c2d851.js"><link rel="prefetch" href="/assets/js/185.789d7f56.js"><link rel="prefetch" href="/assets/js/186.78b3f7fb.js"><link rel="prefetch" href="/assets/js/187.e40efcf5.js"><link rel="prefetch" href="/assets/js/188.6e3b6147.js"><link rel="prefetch" href="/assets/js/189.83e55095.js"><link rel="prefetch" href="/assets/js/19.d176ddb1.js"><link rel="prefetch" href="/assets/js/190.2100f1dc.js"><link rel="prefetch" href="/assets/js/191.7704dfb9.js"><link rel="prefetch" href="/assets/js/192.20a743cd.js"><link rel="prefetch" href="/assets/js/193.188ac595.js"><link rel="prefetch" href="/assets/js/194.bcdfe025.js"><link rel="prefetch" href="/assets/js/195.3e79c373.js"><link rel="prefetch" href="/assets/js/196.6e06e747.js"><link rel="prefetch" href="/assets/js/197.59fb6eb7.js"><link rel="prefetch" href="/assets/js/198.c016b003.js"><link rel="prefetch" href="/assets/js/199.d6db7a40.js"><link rel="prefetch" href="/assets/js/20.ba175671.js"><link rel="prefetch" href="/assets/js/200.89a7e3b7.js"><link rel="prefetch" href="/assets/js/201.bc1ae17a.js"><link rel="prefetch" href="/assets/js/202.2b45a6d3.js"><link rel="prefetch" href="/assets/js/203.6a50ea2b.js"><link rel="prefetch" href="/assets/js/204.83fbd5fa.js"><link rel="prefetch" href="/assets/js/205.280c3690.js"><link rel="prefetch" href="/assets/js/206.2b014b45.js"><link rel="prefetch" href="/assets/js/207.f03b3fb5.js"><link rel="prefetch" href="/assets/js/208.bf33783d.js"><link rel="prefetch" href="/assets/js/209.3a86b5a7.js"><link rel="prefetch" href="/assets/js/21.511919a2.js"><link rel="prefetch" href="/assets/js/210.89278b0f.js"><link rel="prefetch" href="/assets/js/211.dd34bba0.js"><link rel="prefetch" href="/assets/js/212.f4abf9d0.js"><link rel="prefetch" href="/assets/js/213.77d7d506.js"><link rel="prefetch" href="/assets/js/214.aff951c1.js"><link rel="prefetch" href="/assets/js/215.bb76d39a.js"><link rel="prefetch" href="/assets/js/216.d23b9e0d.js"><link rel="prefetch" href="/assets/js/217.d2db70de.js"><link rel="prefetch" href="/assets/js/218.51ba4b8b.js"><link rel="prefetch" href="/assets/js/219.0ab29812.js"><link rel="prefetch" href="/assets/js/22.f13c23fb.js"><link rel="prefetch" href="/assets/js/220.0164df94.js"><link rel="prefetch" href="/assets/js/221.12941196.js"><link rel="prefetch" href="/assets/js/222.a1d22876.js"><link rel="prefetch" href="/assets/js/223.c1f01cd8.js"><link rel="prefetch" href="/assets/js/224.2eb2310f.js"><link rel="prefetch" href="/assets/js/225.f4d01f63.js"><link rel="prefetch" href="/assets/js/226.552fb6c2.js"><link rel="prefetch" href="/assets/js/227.bb335fb1.js"><link rel="prefetch" href="/assets/js/228.7f4597d0.js"><link rel="prefetch" href="/assets/js/229.df597f6c.js"><link rel="prefetch" href="/assets/js/23.52bfe11b.js"><link rel="prefetch" href="/assets/js/230.6e78bc22.js"><link rel="prefetch" href="/assets/js/231.a244b47c.js"><link rel="prefetch" href="/assets/js/232.18fbf45a.js"><link rel="prefetch" href="/assets/js/233.d240a9eb.js"><link rel="prefetch" href="/assets/js/234.0a698229.js"><link rel="prefetch" href="/assets/js/235.7ec16006.js"><link rel="prefetch" href="/assets/js/236.43f46032.js"><link rel="prefetch" href="/assets/js/237.e64d63fa.js"><link rel="prefetch" href="/assets/js/238.04c0fe24.js"><link rel="prefetch" href="/assets/js/239.60ced9b5.js"><link rel="prefetch" href="/assets/js/24.55e025b8.js"><link rel="prefetch" href="/assets/js/240.b0644efe.js"><link rel="prefetch" href="/assets/js/241.c46033d4.js"><link rel="prefetch" href="/assets/js/242.0e9777c5.js"><link rel="prefetch" href="/assets/js/243.c4f39b6e.js"><link rel="prefetch" href="/assets/js/244.f32df722.js"><link rel="prefetch" href="/assets/js/245.deaccac7.js"><link rel="prefetch" href="/assets/js/246.c712f52e.js"><link rel="prefetch" href="/assets/js/247.a40da609.js"><link rel="prefetch" href="/assets/js/248.9a9797e9.js"><link rel="prefetch" href="/assets/js/249.40ace4ec.js"><link rel="prefetch" href="/assets/js/25.878397a3.js"><link rel="prefetch" href="/assets/js/250.fbceed75.js"><link rel="prefetch" href="/assets/js/251.c0d398c2.js"><link rel="prefetch" href="/assets/js/252.31547024.js"><link rel="prefetch" href="/assets/js/253.23c90d1a.js"><link rel="prefetch" href="/assets/js/254.7c3f40ed.js"><link rel="prefetch" href="/assets/js/255.27d75fb6.js"><link rel="prefetch" href="/assets/js/256.bea8eda9.js"><link rel="prefetch" href="/assets/js/257.a3f9d502.js"><link rel="prefetch" href="/assets/js/258.844353e6.js"><link rel="prefetch" href="/assets/js/259.8174d0ca.js"><link rel="prefetch" href="/assets/js/26.106b757c.js"><link rel="prefetch" href="/assets/js/260.5dae4e52.js"><link rel="prefetch" href="/assets/js/261.0a0f04d5.js"><link rel="prefetch" href="/assets/js/262.20ab3921.js"><link rel="prefetch" href="/assets/js/263.fbff3470.js"><link rel="prefetch" href="/assets/js/264.67b0011f.js"><link rel="prefetch" href="/assets/js/265.b134814a.js"><link rel="prefetch" href="/assets/js/266.f367d39f.js"><link rel="prefetch" href="/assets/js/267.118e22e3.js"><link rel="prefetch" href="/assets/js/268.761bf15e.js"><link rel="prefetch" href="/assets/js/269.2160f40e.js"><link rel="prefetch" href="/assets/js/27.9d096c38.js"><link rel="prefetch" href="/assets/js/270.1e7fba00.js"><link rel="prefetch" href="/assets/js/28.119b1dee.js"><link rel="prefetch" href="/assets/js/29.45f94033.js"><link rel="prefetch" href="/assets/js/30.82b2ebda.js"><link rel="prefetch" href="/assets/js/31.8202b94d.js"><link rel="prefetch" href="/assets/js/32.4148df0b.js"><link rel="prefetch" href="/assets/js/33.03817170.js"><link rel="prefetch" href="/assets/js/34.35be15c8.js"><link rel="prefetch" href="/assets/js/35.79d37800.js"><link rel="prefetch" href="/assets/js/36.000f81b2.js"><link rel="prefetch" href="/assets/js/37.c1b0043f.js"><link rel="prefetch" href="/assets/js/38.33095383.js"><link rel="prefetch" href="/assets/js/39.c522949a.js"><link rel="prefetch" href="/assets/js/4.d415e873.js"><link rel="prefetch" href="/assets/js/40.09b84755.js"><link rel="prefetch" href="/assets/js/41.00fe279b.js"><link rel="prefetch" href="/assets/js/42.dcedd7f5.js"><link rel="prefetch" href="/assets/js/43.5dfe762e.js"><link rel="prefetch" href="/assets/js/44.c9eb68e3.js"><link rel="prefetch" href="/assets/js/45.e388caea.js"><link rel="prefetch" href="/assets/js/46.a5b5b423.js"><link rel="prefetch" href="/assets/js/47.ff503fcc.js"><link rel="prefetch" href="/assets/js/48.8e092533.js"><link rel="prefetch" href="/assets/js/49.90eacc4b.js"><link rel="prefetch" href="/assets/js/5.92112685.js"><link rel="prefetch" href="/assets/js/50.b480cdd3.js"><link rel="prefetch" href="/assets/js/51.746ff09f.js"><link rel="prefetch" href="/assets/js/52.14a22694.js"><link rel="prefetch" href="/assets/js/53.b11bee5d.js"><link rel="prefetch" href="/assets/js/54.6b929d66.js"><link rel="prefetch" href="/assets/js/55.86085b43.js"><link rel="prefetch" href="/assets/js/56.54cbf2cb.js"><link rel="prefetch" href="/assets/js/57.0f6dc9bf.js"><link rel="prefetch" href="/assets/js/58.69175595.js"><link rel="prefetch" href="/assets/js/59.d4033cb1.js"><link rel="prefetch" href="/assets/js/6.021ba386.js"><link rel="prefetch" href="/assets/js/60.a37519a0.js"><link rel="prefetch" href="/assets/js/61.73d99dc8.js"><link rel="prefetch" href="/assets/js/62.29bb2a31.js"><link rel="prefetch" href="/assets/js/63.70f87357.js"><link rel="prefetch" href="/assets/js/64.b1e83047.js"><link rel="prefetch" href="/assets/js/65.273732b6.js"><link rel="prefetch" href="/assets/js/66.45441299.js"><link rel="prefetch" href="/assets/js/67.4b35901c.js"><link rel="prefetch" href="/assets/js/68.e9c43cca.js"><link rel="prefetch" href="/assets/js/69.cdb6f004.js"><link rel="prefetch" href="/assets/js/7.9b3e0028.js"><link rel="prefetch" href="/assets/js/70.631df292.js"><link rel="prefetch" href="/assets/js/71.88052383.js"><link rel="prefetch" href="/assets/js/72.19e3d3c4.js"><link rel="prefetch" href="/assets/js/73.fbb3731e.js"><link rel="prefetch" href="/assets/js/74.0ef8dd14.js"><link rel="prefetch" href="/assets/js/75.347928cb.js"><link rel="prefetch" href="/assets/js/76.4e2a4ebc.js"><link rel="prefetch" href="/assets/js/77.7922564c.js"><link rel="prefetch" href="/assets/js/78.d8cb3dbd.js"><link rel="prefetch" href="/assets/js/79.9b9003bf.js"><link rel="prefetch" href="/assets/js/8.a61d9b05.js"><link rel="prefetch" href="/assets/js/80.759fa626.js"><link rel="prefetch" href="/assets/js/81.0718fff1.js"><link rel="prefetch" href="/assets/js/82.73a3c561.js"><link rel="prefetch" href="/assets/js/83.236cae23.js"><link rel="prefetch" href="/assets/js/84.f1bb96b1.js"><link rel="prefetch" href="/assets/js/85.78665b1f.js"><link rel="prefetch" href="/assets/js/86.72580a7e.js"><link rel="prefetch" href="/assets/js/87.f48f7247.js"><link rel="prefetch" href="/assets/js/88.a6baf9aa.js"><link rel="prefetch" href="/assets/js/89.919fdb21.js"><link rel="prefetch" href="/assets/js/9.2d21b0a9.js"><link rel="prefetch" href="/assets/js/90.513fcf89.js"><link rel="prefetch" href="/assets/js/91.9ac17562.js"><link rel="prefetch" href="/assets/js/92.e30dacba.js"><link rel="prefetch" href="/assets/js/93.effb3b0b.js"><link rel="prefetch" href="/assets/js/94.29d57aba.js"><link rel="prefetch" href="/assets/js/95.651e138f.js"><link rel="prefetch" href="/assets/js/96.d642da84.js"><link rel="prefetch" href="/assets/js/97.10461123.js"><link rel="prefetch" href="/assets/js/98.bb8bd51d.js"><link rel="prefetch" href="/assets/js/99.0423af80.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.2375488b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bf9a1d7a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">山河社稷图</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">面试收集</a></div><div class="nav-item"><a href="/zh/SpringBoot/" class="nav-link">SpringBoot</a></div><div class="nav-item"><a href="/zh/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/zh/changelog/" class="nav-link">Changelog</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/Docker Old/Docker Compose/Docker_Gitlab_Jenkins搭建CICD/04-jenkins pipeline + gitlab + docker 实现CI  CD功能.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/zhengxiaochuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    官网
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">指南</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">面试收集</a></div><div class="nav-item"><a href="/zh/SpringBoot/" class="nav-link">SpringBoot</a></div><div class="nav-item"><a href="/zh/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/zh/changelog/" class="nav-link">Changelog</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/Docker Old/Docker Compose/Docker_Gitlab_Jenkins搭建CICD/04-jenkins pipeline + gitlab + docker 实现CI  CD功能.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/zhengxiaochuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    官网
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jenkins-pipeline-gitlab-docker-实现-ci-cd-功能"><a href="#jenkins-pipeline-gitlab-docker-实现-ci-cd-功能" class="header-anchor">#</a> Jenkins pipeline + gitlab + docker 实现 CI / CD 功能</h1> <h2 id="jenkins-pipeline-gitlab-docker-实现-ci-cd-功能-2"><a href="#jenkins-pipeline-gitlab-docker-实现-ci-cd-功能-2" class="header-anchor">#</a> Jenkins pipeline + gitlab + docker 实现 CI / CD 功能</h2> <h4 id="创建任务"><a href="#创建任务" class="header-anchor">#</a> 创建任务</h4> <p>也跟之前的手动构建任务一样，添加一个参数用于标记是构建操作还是回退操作</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16cffed551813076?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p> <p>下面就开始编写 pipeline 脚本用于构建操作</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16cffed770740496?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p> <h4 id="第一步-准备阶段"><a href="#第一步-准备阶段" class="header-anchor">#</a> 第一步 准备阶段</h4> <p>这个阶段需要完成代码从 gitlab 中 checkout 到本地，用于后续的操作</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Source'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       git branch<span class="token punctuation">:</span> <span class="token string">'master'</span><span class="token punctuation">,</span> credentialsId<span class="token punctuation">:</span> <span class="token string">'a4f6f384-4d9c-4dcf-bc1c-c3df536cdbdc'</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">'git@git.xxx.com:jeff/citest2.git'</span>
       <span class="token keyword">def</span> container_name <span class="token operator">=</span> <span class="token string">'citest'</span>
       <span class="token keyword">def</span> git_tag <span class="token operator">=</span> <span class="token function">sh</span><span class="token punctuation">(</span>script<span class="token punctuation">:</span> <span class="token string">'git describe --always --tag'</span><span class="token punctuation">,</span> returnStdout<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_manual_'</span> <span class="token operator">+</span> env<span class="token operator">.</span>BUILD_NUMBER
       <span class="token keyword">def</span> container_full_name <span class="token operator">=</span> container_name <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> git_tag
       <span class="token keyword">def</span> repository <span class="token operator">=</span> <span class="token string">'registry.cn-shanghai.aliyuncs.com/xxx/'</span> <span class="token operator">+</span> container_name <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> git_tag
       println <span class="token string">'container_full_name: '</span> <span class="token operator">+</span> container_full_name 
       println <span class="token string">'repository: '</span> <span class="token operator">+</span> repository
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>点击应用测试效果，构建任务输出</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>using credential a4f6f384-4d9c-4dcf-bc1c-c3df536cdbdc
 <span class="token operator">&gt;</span> <span class="token function">git</span> rev-parse --is-inside-work-tree <span class="token comment"># timeout=10</span>
Fetching changes from the remote Git repository
 <span class="token operator">&gt;</span> <span class="token function">git</span> config remote.origin.url git@git.xxx.com:jeff/citest2.git <span class="token comment"># timeout=10</span>
Fetching upstream changes from git@git.xxx.com:jeff/citest2.git
 <span class="token operator">&gt;</span> <span class="token function">git</span> --version <span class="token comment"># timeout=10</span>
using GIT_SSH to <span class="token builtin class-name">set</span> credentials 
 <span class="token operator">&gt;</span> <span class="token function">git</span> fetch --tags --progress git@git.xxx.com:jeff/citest2.git +refs/heads/*:refs/remotes/origin/*
 <span class="token operator">&gt;</span> <span class="token function">git</span> rev-parse refs/remotes/origin/master^<span class="token punctuation">{</span>commit<span class="token punctuation">}</span> <span class="token comment"># timeout=10</span>
 <span class="token operator">&gt;</span> <span class="token function">git</span> rev-parse refs/remotes/origin/origin/master^<span class="token punctuation">{</span>commit<span class="token punctuation">}</span> <span class="token comment"># timeout=10</span>
Checking out Revision 87a5f818724b3954e87363ec271b095355f11d69 <span class="token punctuation">(</span>refs/remotes/origin/master<span class="token punctuation">)</span>
 <span class="token operator">&gt;</span> <span class="token function">git</span> config core.sparsecheckout <span class="token comment"># timeout=10</span>
 <span class="token operator">&gt;</span> <span class="token function">git</span> checkout -f 87a5f818724b3954e87363ec271b095355f11d69
 <span class="token operator">&gt;</span> <span class="token function">git</span> branch -a -v --no-abbrev <span class="token comment"># timeout=10</span>
 <span class="token operator">&gt;</span> <span class="token function">git</span> branch -D master <span class="token comment"># timeout=10</span>
 <span class="token operator">&gt;</span> <span class="token function">git</span> checkout -b master 87a5f818724b3954e87363ec271b095355f11d69
Commit message: <span class="token string">&quot;修复打包镜像的可执行文件无法运行的问题&quot;</span>
 <span class="token operator">&gt;</span> <span class="token function">git</span> rev-list --no-walk 87a5f818724b3954e87363ec271b095355f11d69 <span class="token comment"># timeout=10</span>
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> <span class="token function">sh</span>
+ <span class="token function">git</span> describe --always --tag
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> <span class="token builtin class-name">echo</span>
container_full_name: citest-v1.3.3_manual_4
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> <span class="token builtin class-name">echo</span>
repository: registry.cn-shanghai.aliyuncs.com/xxx/citest:v1.3.3_manual_4
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> // stage
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> // node
<span class="token punctuation">[</span>Pipeline<span class="token punctuation">]</span> End of Pipeline
Finished: SUCCESS
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>检查输出内容没有问题，仓库 checkout 到此完成</p> <p>注意：这里有一点就是说，代码检出的仓库如果是需要认证信息的，需要显式的传递 credentialsId 表示使用 Jenkins 中配置的凭据，这个 id 也可以自定义配置，如果是不需要认证新的话，可以直接使用 <strong>checkout scm</strong> 来 checkout 代码</p> <h4 id="第二步-构建-docker-镜像到阿里云-registry"><a href="#第二步-构建-docker-镜像到阿里云-registry" class="header-anchor">#</a> 第二步 构建 docker 镜像到阿里云 registry</h4> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Source'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        git branch<span class="token punctuation">:</span> <span class="token string">'master'</span><span class="token punctuation">,</span> credentialsId<span class="token punctuation">:</span> <span class="token string">'a4f6f384-4d9c-4dcf-bc1c-c3df536cdbdc'</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">'git@git.xxx.com:jeff/citest2.git'</span>
        <span class="token keyword">def</span> container_name <span class="token operator">=</span> <span class="token string">'citest'</span>
        <span class="token keyword">def</span> git_tag <span class="token operator">=</span> <span class="token function">sh</span><span class="token punctuation">(</span>script<span class="token punctuation">:</span> <span class="token string">'git describe --always --tag'</span><span class="token punctuation">,</span> returnStdout<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_manual_'</span> <span class="token operator">+</span> env<span class="token operator">.</span>BUILD_NUMBER
        container_full_name <span class="token operator">=</span> container_name <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> git_tag
        repository <span class="token operator">=</span> <span class="token string">'registry.cn-shanghai.aliyuncs.com/xxx/'</span> <span class="token operator">+</span> container_name <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> git_tag
        println container_full_name
        println repository
   <span class="token punctuation">}</span>
   
   <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        docker<span class="token operator">.</span><span class="token function">withRegistry</span><span class="token punctuation">(</span><span class="token string">'https://registry.cn-shanghai.aliyuncs.com'</span><span class="token punctuation">,</span> <span class="token string">'ali_docker_registry'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token operator">.</span><span class="token function">build</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span>
            customImage<span class="token operator">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            sh <span class="token string">'docker images | grep citest | awk \'{print $1&quot;:&quot;$2}\' | xargs docker rmi -f || true'</span>
            sh <span class="token string">'docker rmi -f  `docker images | grep \'&lt;none&gt;\' | awk \'{print $3}\'` || true'</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里添加一个新的步骤，将 pull 的代码仓库构建 docker 镜像，然后 push 到阿里云 registry 中，这里的认证信心也是保存到 jenkins 的全局凭据中，并且自定义id为 <strong>ali_docker_registry</strong></p> <p>**注意：**这个每个stage中变量使用 def 声明的变量，在其他的 stage 中无法访问，如果去掉了这个声明则可以正常访问</p> <p>测试手动执行后阿里云镜像仓库成功创建了信息镜像</p> <h4 id="第三步-通知目标的机器自动拉取镜像并执行"><a href="#第三步-通知目标的机器自动拉取镜像并执行" class="header-anchor">#</a> 第三步 通知目标的机器自动拉取镜像并执行</h4> <p>这里有三个想法</p> <ol><li>通过 ssh 连接到目标机器，然后执行 pull 的命令及清理的操作，跟之前的操作区别不大，只是用pipeline进行了包装</li> <li>通过将目标机器配置为 jenkins 的一个节点机器，并且只执行指定的 job ，然后在后面的部署的 stage 由指定的节点执行，减少一个显式的 ssh 连接过程，但是 pipeline 要多一些编写</li> <li>配置开启远端的 docker 服务器的 TSL 远程访问，好处是可以直接使用 pipeline 的 docker 库完成连接及操作，官方的 demo 也是这个方式，但是没有找到删除镜像的方法，估计这个插件主要目的还是为了构建作用而不是用于自动部署的时候使用</li></ol> <p>所以最终还是使用第一种想法来继续完成自动部署的功能</p> <h4 id="通过-ssh-pipeline-steps-连接其他主机"><a href="#通过-ssh-pipeline-steps-连接其他主机" class="header-anchor">#</a> 通过 SSH Pipeline Steps 连接其他主机</h4> <p>这里通过将远端主机的连接信息保存至全局的 jenkins 凭据中，便于使用，然后再 pipeline 中使用时通过 <strong>SSH Pipeline Steps</strong> 这个插件来完成 ssh 连接动作，主要参考 <a href="https://link.juejin.im/?target=https%3A%2F%2Fjenkins.io%2Fblog%2F2019%2F02%2F06%2Fssh-steps-for-jenkins-pipeline%2F" target="_blank" rel="noopener noreferrer">SSH Steps for Jenkins Pipeline<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>首先安装 <strong>SSH Pipeline Steps</strong> 插件</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16cffee81303392d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p> <p>然后添加一个远端主机连接的连接用户信息及密码</p> <p><img src="https://user-gold-cdn.xitu.io/2019/9/5/16cffeeda87ec079?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p> <p>然后继续编写pipeline脚本完成ssh远程执行自动部署操作</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code><span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
    <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token punctuation">:</span> <span class="token string">'pro4_ssh'</span><span class="token punctuation">,</span> passwordVariable<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token punctuation">:</span> <span class="token string">'userName'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">def</span> remote <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        remote<span class="token operator">.</span>name <span class="token operator">=</span> <span class="token string">'pro4'</span>
        remote<span class="token operator">.</span>user <span class="token operator">=</span> userName
        remote<span class="token operator">.</span>host <span class="token operator">=</span> <span class="token string">'47.111.111.111'</span>
        remote<span class="token operator">.</span>password <span class="token operator">=</span> password
        remote<span class="token operator">.</span>allowAnyHosts <span class="token operator">=</span> <span class="token boolean">true</span>

        writeFile file<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string gstring">&quot;&quot;&quot;
        docker ps | grep citest | awk '{print \$2}' &gt;&gt; /data/jenkins/mi_test_history
        echo /data/jenkins/mi_test_history
        docker ps | grep citest | awk '{print \$1}' | xargs docker kill || true
        docker images | grep citest | awk '{print \$1&quot;:&quot;\$2}' | xargs docker rmi -f || true
        docker login --username=yourName --password=yourPassword registry.cn-shanghai.aliyuncs.com
        docker pull <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repository<span class="token punctuation">}</span></span>
        docker run -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repository<span class="token punctuation">}</span></span>
        &quot;&quot;&quot;</span>

        sshPut remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span><span class="token punctuation">,</span> into<span class="token punctuation">:</span> <span class="token string">'.'</span>
        sshScript remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> script<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span>
        sshRemove remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><strong>注意</strong>，如果要在字符串中使用拼接变量必须使用 &quot; 包裹字符串内容而不是 '</p> <p>手动构建任务查看结果，镜像成功运行，并且记录之前的镜像记录</p> <h4 id="支持参数判断完成回滚功能"><a href="#支持参数判断完成回滚功能" class="header-anchor">#</a> 支持参数判断完成回滚功能</h4> <p>部署没有问题就直接将之前回滚的脚本移植到目前的pipeline的写法中，完整的脚本如下</p> <div class="language-groovy line-numbers-mode"><pre class="language-groovy"><code>node <span class="token punctuation">{</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">.</span>CTRL_BUILD <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Source'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            git branch<span class="token punctuation">:</span> <span class="token string">'master'</span><span class="token punctuation">,</span> credentialsId<span class="token punctuation">:</span> <span class="token string">'a4f6f384-4d9c-4dcf-bc1c-c3df536cdbdc'</span><span class="token punctuation">,</span> url<span class="token punctuation">:</span> <span class="token string">'git@git.xxx.com:jeff/citest2.git'</span>
            <span class="token keyword">def</span> container_name <span class="token operator">=</span> <span class="token string">'citest'</span>
            <span class="token keyword">def</span> git_tag <span class="token operator">=</span> <span class="token function">sh</span><span class="token punctuation">(</span>script<span class="token punctuation">:</span> <span class="token string">'git describe --always --tag'</span><span class="token punctuation">,</span> returnStdout<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_manual_'</span> <span class="token operator">+</span> env<span class="token operator">.</span>BUILD_NUMBER
            <span class="token keyword">def</span> container_full_name <span class="token operator">=</span> container_name <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> git_tag
            repository <span class="token operator">=</span> <span class="token string">'registry.cn-shanghai.aliyuncs.com/xxx/'</span> <span class="token operator">+</span> container_name <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> git_tag
            println container_full_name
            println repository
        <span class="token punctuation">}</span>
       
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'Build'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            docker<span class="token operator">.</span><span class="token function">withRegistry</span><span class="token punctuation">(</span><span class="token string">'https://registry.cn-shanghai.aliyuncs.com'</span><span class="token punctuation">,</span> <span class="token string">'ali_docker_registry'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">def</span> customImage <span class="token operator">=</span> docker<span class="token operator">.</span><span class="token function">build</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span>
                customImage<span class="token operator">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                
                sh <span class="token string">'docker images | grep citest | awk \'{print $1&quot;:&quot;$2}\' | xargs docker rmi -f || true'</span>
                sh <span class="token string">'docker rmi -f  `docker images | grep \'&lt;none&gt;\' | awk \'{print $3}\'` || true'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
       
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'deploy'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          
            <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token punctuation">:</span> <span class="token string">'pro4_ssh'</span><span class="token punctuation">,</span> passwordVariable<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token punctuation">:</span> <span class="token string">'userName'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           
                <span class="token keyword">def</span> remote <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                remote<span class="token operator">.</span>name <span class="token operator">=</span> <span class="token string">'pro4'</span>
                remote<span class="token operator">.</span>user <span class="token operator">=</span> userName
                remote<span class="token operator">.</span>host <span class="token operator">=</span> <span class="token string">'47.101.137.187'</span>
                remote<span class="token operator">.</span>password <span class="token operator">=</span> password
                remote<span class="token operator">.</span>allowAnyHosts <span class="token operator">=</span> <span class="token boolean">true</span>
                
                writeFile file<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string gstring">&quot;&quot;&quot;
                    docker ps | grep citest | awk '{print \$2}' &gt;&gt; /data/jenkins/mi_test_history
                    echo /data/jenkins/mi_test_history
                    docker ps | grep citest | awk '{print \$1}' | xargs docker kill || true
                    docker images | grep citest | awk '{print \$1&quot;:&quot;\$2}' | xargs docker rmi -f || true
                    docker login --username=yourName --password=yourPassword registry.cn-shanghai.aliyuncs.com
                    docker pull <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repository<span class="token punctuation">}</span></span>
                    docker run -d <span class="token expression"><span class="token punctuation">$</span><span class="token punctuation">{</span>repository<span class="token punctuation">}</span></span>
                &quot;&quot;&quot;</span>
    
                sshPut remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span><span class="token punctuation">,</span> into<span class="token punctuation">:</span> <span class="token string">'.'</span>
                sshScript remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> script<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span>
                sshRemove remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token string">'poll.sh'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">'rollback'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">withCredentials</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">usernamePassword</span><span class="token punctuation">(</span>credentialsId<span class="token punctuation">:</span> <span class="token string">'pro4_ssh'</span><span class="token punctuation">,</span> passwordVariable<span class="token punctuation">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span> usernameVariable<span class="token punctuation">:</span> <span class="token string">'userName'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           
                <span class="token keyword">def</span> remote <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                remote<span class="token operator">.</span>name <span class="token operator">=</span> <span class="token string">'pro4'</span>
                remote<span class="token operator">.</span>user <span class="token operator">=</span> userName
                remote<span class="token operator">.</span>host <span class="token operator">=</span> <span class="token string">'47.111.111.111'</span>
                remote<span class="token operator">.</span>password <span class="token operator">=</span> password
                remote<span class="token operator">.</span>allowAnyHosts <span class="token operator">=</span> <span class="token boolean">true</span>
                
                writeFile file<span class="token punctuation">:</span> <span class="token string">'roll.sh'</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string">'''
                    popline(){ LC_CTYPE=C l=`tail -&quot;${2:-1}&quot; &quot;$1&quot;; echo t`; l=${l%t}; truncate -s &quot;-${#l}&quot; &quot;$1&quot;; printf %s &quot;$l&quot;; }
            	    last=`popline /data/jenkins/mi_test_history || &quot;&quot;`
            	    if [ -n &quot;$last&quot; ]; then
            	        docker ps | grep citest | awk '{print $1}' | xargs docker kill || true
            	        docker images | grep citest | awk '{print $1&quot;:&quot;$2}' | xargs docker rmi -f || true
            	        docker login --username=yourName --password=yourPassword registry.cn-shanghai.aliyuncs.com
            	        docker pull $last
            	        docker run -d $last
            	        echo &quot;rollback to $last success&quot;
            	    else
            	        echo &quot;nothing to rollback&quot;
            	    fi
                '''</span>
    
                sshPut remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">'roll.sh'</span><span class="token punctuation">,</span> into<span class="token punctuation">:</span> <span class="token string">'.'</span>
                sshScript remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> script<span class="token punctuation">:</span> <span class="token string">'roll.sh'</span>
                sshRemove remote<span class="token punctuation">:</span> remote<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token string">'roll.sh'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><p>使用一次构建及一次回滚操作，目标主机上查看操作结果</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@izuf69bpbvay7p0ozdhq6bz jenkins<span class="token punctuation">]</span><span class="token comment"># cat mi_test_history</span>
registry.cn-shanghai.aliyuncs.com/xxx/citest:v1.3.3_manual_37
<span class="token punctuation">[</span>root@izuf69bpbvay7p0ozdhq6bz jenkins<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID        IMAGE                                                                COMMAND                  CREATED             STATUS              PORTS               NAMES
fd5a375be004        registry.cn-shanghai.aliyuncs.com/xxx/citest:v1.3.3_manual_40   <span class="token string">&quot;./test&quot;</span>                 <span class="token number">13</span> seconds ago      Up <span class="token number">12</span> seconds                           beautiful_hoover
16df7cae17a3        docker-elk_kibana                                                    <span class="token string">&quot;/usr/local/bin/kiba…&quot;</span>   <span class="token number">2</span> months ago        Up <span class="token number">2</span> months                             docker-elk_kibana_1
ad8056879f70        docker-elk_logstash                                                  <span class="token string">&quot;/usr/local/bin/dock…&quot;</span>   <span class="token number">2</span> months ago        Up <span class="token number">2</span> months                             docker-elk_logstash_1
236f6ed9a404        docker-elk_elasticsearch                                             <span class="token string">&quot;/usr/local/bin/dock…&quot;</span>   <span class="token number">2</span> months ago        Up <span class="token number">2</span> months                             docker-elk_elasticsearch_1
<span class="token punctuation">[</span>root@izuf69bpbvay7p0ozdhq6bz jenkins<span class="token punctuation">]</span><span class="token comment"># cat mi_test_history</span>
<span class="token punctuation">[</span>root@izuf69bpbvay7p0ozdhq6bz jenkins<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID        IMAGE                                                                COMMAND                  CREATED             STATUS              PORTS               NAMES
12f23fec4a5f        registry.cn-shanghai.aliyuncs.com/xxx/citest:v1.3.3_manual_37   <span class="token string">&quot;./test&quot;</span>                 <span class="token number">9</span> seconds ago       Up <span class="token number">8</span> seconds                            eager_napier
16df7cae17a3        docker-elk_kibana                                                    <span class="token string">&quot;/usr/local/bin/kiba…&quot;</span>   <span class="token number">2</span> months ago        Up <span class="token number">2</span> months                             docker-elk_kibana_1
ad8056879f70        docker-elk_logstash                                                  <span class="token string">&quot;/usr/local/bin/dock…&quot;</span>   <span class="token number">2</span> months ago        Up <span class="token number">2</span> months                             docker-elk_logstash_1
236f6ed9a404        docker-elk_elasticsearch                                             <span class="token string">&quot;/usr/local/bin/dock…&quot;</span>   <span class="token number">2</span> months ago        Up <span class="token number">2</span> months                             docker-elk_elasticsearch_1
<span class="token punctuation">[</span>root@izuf69bpbvay7p0ozdhq6bz jenkins<span class="token punctuation">]</span><span class="token comment">#</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>构建及回滚操作都成功</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/14/2019, 6:58:15 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ace6c021.js" defer></script><script src="/assets/js/3.c5eec2af.js" defer></script><script src="/assets/js/100.5622807f.js" defer></script>
  </body>
</html>
